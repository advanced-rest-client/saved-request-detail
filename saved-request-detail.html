<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/legacy/class.html">
<link rel="import" href="../polymer/lib/utils/render-status.html">
<link rel="import" href="../http-method-label/http-method-label.html">
<link rel="import" href="../date-time/date-time.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../markdown-styles/markdown-styles.html">
<link rel="import" href="../paper-chip/paper-chip.html">
<dom-module id="saved-request-detail">
  <template>
    <style include="markdown-styles"></style>
    <style>
    :host {
      display: block;
      @apply --arc-font-body1;
      @apply --saved-request-detail;
    }

    h2 {
      @apply --arc-font-headline;
    }

    .address-detail {
      @apply --layout-horizontal;
      @apply --layout-center;
    }

    .url-label {
      @apply --arc-font-common-nowrap;
      font-size: 16px;
      @apply --saved-request-detail-url-label;
    }

    http-method-label {
      font-size: 13px;
      margin-right: 12px;
      padding: 8px;
      @apply --saved-request-detail-method-label;
    }

    .description {
      max-width: var(--saved-request-detail-description-max-width, 700px);
      color: var(--saved-request-detail-description-color, rgba(0, 0, 0, 0.64));
      @apply --saved-request-detail-description;
    }

    .meta-row {
      @apply --layout-horizontal;
      @apply --layout-center;
      color: rgba(0, 0, 0, 0.87);
      height: 40px;
      @apply --saved-request-detail-meta-row;
    }

    .meta-row .label {
      width: 160px;
      @apply --saved-request-detail-meta-row-label;
    }

    .meta-row .value {
      @apply --arc-font-common-nowrap;
      @apply --saved-request-detail-meta-row-value;
    }

    .actions {
      @apply --layout-horizontal;
      @apply --layout-end-justified;
      margin-top: 20px;
      @apply --saved-request-detail-actions-container;
    }

    .actions paper-button {
      color: var(--primary-color);
      padding-left: 12px;
      padding-right: 12px;
      @apply --saved-request-detail-action-buttons;
    }

    paper-button iron-icon {
      margin-right: 12px;
      color: var(--saved-request-detail-action-icon-color, rgba(0, 0, 0, 0.54));
      @apply --saved-request-detail-action-icon;
    }

    marked-element {
      margin-top: 20px;
    }

    .project-link {
      @apply --arc-link;
    }

    paper-chip {
      cursor: pointer;
    }

    paper-chip[disabled] {
      --paper-chip-container: {
        border: 1px var(--error-color) solid;
      };
    }
    </style>
    <template is="dom-if" if="[[isHistory]]">
      <h2>Request details</h2>
    </template>
    <template is="dom-if" if="[[!isHistory]]">
      <h2>[[request.name]]</h2>
    </template>
    <div class="address-detail">
      <http-method-label method="[[request.method]]"></http-method-label>
      <span class="url-label">[[request.url]]</span>
    </div>
    <template is="dom-if" if="[[request.description]]">
      <marked-element markdown="[[request.description]]">
        <div class="markdown-html markdown-body description"></div>
      </marked-element>
    </template>

    <div class="meta-row">
      <div class="label">
        Created
      </div>
      <div class="value">
        <date-time date="[[request.created]]" year="numeric" month="numeric" day="numeric" hour="numeric" minute="numeric"></date-time>
      </div>
    </div>
    <template is="dom-if" if="[[request.driveId]]">
      <div class="meta-row">
        <div class="label">
          Drive file
        </div>
        <div class="value">
          [[request.driveId]]
        </div>
      </div>
    </template>
    <template is="dom-if" if="[[_projects]]">
      <div class="meta-row">
        <div class="label">
          Projects
        </div>
        <div class="value">
          <template is="dom-repeat" items="[[_projects]]">
            <paper-chip disabled$="[[item.missing]]" title="Open project details" on-click="_openProject" data-action="open-project">[[item.name]]</paper-chip>
          </template>
        </div>
      </div>
    </template>
    <div class="actions">
      <template is="dom-if" if="[[isSaved]]">
        <paper-button on-click="_deleteRequest" data-action="delete-request" title="Removes request from the data store">
          <iron-icon icon="arc:delete"></iron-icon>
          Delete
        </paper-button>
      </template>
      <paper-button on-click="_editRequest" data-action="edit-request" title="Opens request editor">
        <iron-icon icon="arc:edit"></iron-icon>
        Edit
      </paper-button>
    </div>
  </template>
  <script>
  /**
   * Details applet for saved request object.
   *
   * If the request is a history item the set `isHistory` property to `true`.
   *
   * The applet doesn't support data edit. Element / app hosting this element
   * must handle events sent by this element and support edit action.
   *
   * ### Example
   *
   * ```html
   * <saved-request-detail request="{...}"></saved-request-detail>
   * ```
   *
   * ### Styling
   *
   * `<saved-request-detail>` provides the following custom properties and
   * mixins for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--saved-request-detail` | Mixin applied to the element | `{}`
   * `--saved-request-detail-description` | Mixin applied to request description | `{}`
   * `--saved-request-detail-description-max-width` | Max width of the description element | `700px`
   * `--saved-request-detail-description-color` | Color of the request description |
   * `rgba(0, 0, 0, 0.64)`
   * `--saved-request-detail-url-label` | Mixin applied to the  URL label | `{}`
   * `--saved-request-detail-method-label` | Mixin applied to the `http-method-label` element | `{}`
   * `--saved-request-detail-meta-row` | Mixin applied to the meta data list items | `{}`
   * `--saved-request-detail-meta-row-label` | Mixin applied to the meta data label | `{}`
   * `--saved-request-detail-meta-row-value` | Mixin applied to the meta data value | `{}`
   * `--saved-request-detail-actions-container` | Mixin applied to the buttons container | `{}`
   * `--saved-request-detail-action-buttons` | Mixin applied to the action buttons | `{}`
   * `--saved-request-detail-action-icon` | Mixin applied to action buttons icons  | `{}`
   * `--saved-request-detail-action-icon-color` | Color of the icon in the action
   * button | `rgba(0, 0, 0, 0.54)`
   *
   * @polymer
   * @customElement
   * @memberof UiElements
   * @demo demo/index.html
   * @appliesMixin Polymer.IronResizableBehavior
   */
  class SavedRequestDetail extends
    Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element) {
    static get is() {return 'saved-request-detail';}
    static get properties() {
      return {
        // Request object to render.
        request: {
          type: Object,
          observer: '_requestChanged'
        },
        // True if current item represent a history item.
        isHistory: {
          type: Boolean,
          value: false
        },
        /**
         * Projects data associated with the request.
         * @type {Array<Object>}
         */
        _projects: Array,
        /**
         * Computed value, true if the request has been saved in the data store
         * whether it's saved or history.
         * Because request object can have `_id` generated before saving it to
         * the store this relays on checking both `_id` and `_rev`
         */
        isSaved: {
          type: Boolean,
          value: false,
          computed: '_computeIsSaved(request)'
        }
      };
    }
    /**
     * Sets project data when `request` object change.
     *
     * @param {Object} request
     */
    _requestChanged(request) {
      if (!request) {
        this._projects = undefined;
        return;
      }
      if (request.projects) {
        this._readProjects(request.projects);
      } else if (request.legacyProject) {
        this._readProjects([request.legacyProject]);
      } else if (this._projects) {
        this._projects = undefined;
      }
    }
    // Reads related project data.
    _readProjects(ids) {
      if (!ids || !ids.length) {
        this._projects = undefined;
        return;
      }
      const e = new CustomEvent('project-model-query', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          keys: ids
        }
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        console.warn('Project model not in the DOM.');
        return;
      }
      e.detail.result
      .then((data) => {
        this._projects = data.map((item, i) => {
          if (!item) {
            item = {
              missing: true,
              name: ids[i]
            };
          } else {
            item.missing = false;
          }
          return item;
        });
        Polymer.RenderStatus.afterNextRender(this, () => this.notifyResize());
      });
    }
    /**
     * Sends `navigate` event set to current read project.
     *
     * @param {ClickEvent} e
     */
    _openProject(e) {
      e.preventDefault();
      e.stopPropagation();
      const id = e.model.get('item._id');
      this.dispatchEvent(new CustomEvent('navigate', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          base: 'project',
          id: id
        }
      }));
    }
    /**
     * Sends non-bubbling `delete-request` event to the parent element to perform
     * delete action.
     */
    _deleteRequest() {
      this.dispatchEvent(new CustomEvent('delete-request', {
        composed: true,
        detail: {
          item: this.request
        }
      }));
    }

    /**
     * Sends non-bubbling `edit-request` event to the parent element to perform
     * edit action.
     */
    _editRequest() {
      this.dispatchEvent(new CustomEvent('edit-request', {
        composed: true,
        detail: {
          item: this.request
        }
      }));
    }
    /**
     * Computes value for `isSaved` property.
     * @param {Object} request Passed request object
     * @return {Boolean} True if request has both `_id` and `_rev`.
     */
    _computeIsSaved(request) {
      if (!request) {
        return false;
      }
      return !!(request._id && request._rev);
    }
    /**
     * Fired when the user click on the "edit" action button.
     *
     * This event does not bubbles.
     *
     * @event edit-request
     * @param {Object} item The request object
     */
    /**
     * Fired when the user click on the "delete" action button.
     *
     * This event does not bubbles.
     *
     * @event delete-request
     * @param {Object} item The request object
     */
    /**
     * Fired when the user opens the project item.
     *
     * This event can be fired only if the request has a project.
     *
     * @event navigate
     * @param {String} base Always `project`
     * @param {String} id Project ID
     */
  }
  window.customElements.define(SavedRequestDetail.is, SavedRequestDetail);
  </script>
</dom-module>
