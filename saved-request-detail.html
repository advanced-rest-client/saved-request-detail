<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../http-method-label/http-method-label.html">
<link rel="import" href="../date-time/date-time.html">
<link rel="import" href="../arc-models/project-model.html">
<link rel="import" href="../arc-models/request-model.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<!--
Details applet for saved request object.

If the request is a history item the set `isHistory` property to `true`.

The applet doesn't support data edit. Element / app hosting this element
must handle events sent by this element and support edit action.

### Example
```
<saved-request-detail request="{...}"></saved-request-detail>
```

### Styling
`<saved-request-detail>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--saved-request-detail` | Mixin applied to the element | `{}`
`--saved-request-detail-description` | Mixin applied to request description | `{}`
`--saved-request-detail-description-max-width` | Max width of the description element | `700px`
`--saved-request-detail-description-color` | Color of the request description | `rgba(0, 0, 0, 0.64)`
`--saved-request-detail-url-label` | Mixin applied to the  URL label | `{}`
`--saved-request-detail-method-label` | Mixin applied to the `http-method-label` element | `{}`
`--saved-request-detail-meta-row` | Mixin applied to the meta data list items | `{}`
`--saved-request-detail-meta-row-label` | Mixin applied to the meta data label | `{}`
`--saved-request-detail-meta-row-value` | Mixin applied to the meta data value | `{}`
`--saved-request-detail-actions-container` | Mixin applied to the buttons container | `{}`
`--saved-request-detail-action-buttons` | Mixin applied to the action buttons | `{}`
`--saved-request-detail-action-icon` | Mixin applied to action buttons icons  | `{}`
`--saved-request-detail-action-icon-color` | Color of the icon in the action button | `rgba(0, 0, 0, 0.54)`

@group UI Elements
@element saved-request-detail
@demo demo/index.html
-->
<dom-module id="saved-request-detail">
  <template>
    <style>
    :host {
      display: block;
      @apply --arc-font-body1;
      @apply --saved-request-detail;
    }

    h2 {
      @apply --arc-font-headline;
    }

    .address-detail {
      @apply --layout-horizontal;
      @apply --layout-center;
    }

    .url-label {
      @apply --arc-font-common-nowrap;
      font-size: 16px;
      @apply --saved-request-detail-url-label;
    }

    http-method-label {
      font-size: 13px;
      margin-right: 12px;
      padding: 8px;
      @apply --saved-request-detail-method-label;
    }

    .description {
      max-width: var(--saved-request-detail-description-max-width, 700px);
      color: var(--saved-request-detail-description-color, rgba(0, 0, 0, 0.64));
      @apply --saved-request-detail-description;
    }

    .meta-row {
      @apply --layout-horizontal;
      @apply --layout-center;
      color: rgba(0, 0, 0, 0.87);
      height: 40px;
      @apply --saved-request-detail-meta-row;
    }

    .meta-row .label {
      width: 160px;
      @apply --saved-request-detail-meta-row-label;
    }

    .meta-row .value {
      @apply --arc-font-common-nowrap;
      @apply --saved-request-detail-meta-row-value;
    }

    .actions {
      @apply --layout-horizontal;
      @apply --layout-end-justified;
      margin-top: 20px;
      @apply --saved-request-detail-actions-container;
    }

    .actions paper-button {
      color: var(--primary-color);
      padding-left: 12px;
      padding-right: 12px;
      @apply --saved-request-detail-action-buttons;
    }

    paper-button iron-icon {
      margin-right: 12px;
      color: var(--saved-request-detail-action-icon-color, rgba(0, 0, 0, 0.54));
      @apply --saved-request-detail-action-icon;
    }
    </style>
    <template is="dom-if" if="[[isHistory]]">
      <h2>Request details</h2>
    </template>
    <template is="dom-if" if="[[!isHistory]]">
      <h2>[[request.name]]</h2>
    </template>
    <div class="address-detail">
      <http-method-label method="[[request.method]]"></http-method-label>
      <span class="url-label">[[request.url]]</span>
    </div>
    <template is="dom-if" if="[[request.description]]">
      <p class="description">[[request.description]]</p>
    </template>

    <div class="meta-row">
      <div class="label">
        Created
      </div>
      <div class="value">
        <date-time date="[[request.created]]" year="numeric" month="numeric" day="numeric" hour="numeric" minute="numeric"></date-time>
      </div>
    </div>
    <template is="dom-if" if="[[request.driveId]]">
      <div class="meta-row">
        <div class="label">
          Drive file
        </div>
        <div class="value">
          [[request.driveId]]
        </div>
      </div>
    </template>
    <template is="dom-if" if="[[_project]]">
      <div class="meta-row">
        <div class="label">
          Project
        </div>
        <div class="value">
          [[_project.name]]
          <span>
            <paper-icon-button icon="arc:chevron-right" on-tap="_openProject" data-action="open-project"></paper-icon-button>
            <paper-tooltip>Open project details</paper-tooltip>
          </span>
        </div>
      </div>
    </template>
    <div class="actions">
      <paper-button on-tap="_deleteRequest" data-action="delete-request">
        <iron-icon icon="arc:delete"></iron-icon>
        Delete
      </paper-button>
      <paper-button raised on-tap="_editRequest" data-action="edit-request">
        <iron-icon icon="arc:edit"></iron-icon>
        Edit
      </paper-button>
    </div>
    <project-model events-target="[[_eventsTarget]]"></project-model>
    <request-model events-target="[[_eventsTarget]]"></request-model>
  </template>
  <script>
  Polymer({
    is: 'saved-request-detail',
    behaviors: [
      Polymer.IronResizableBehavior
    ],
    /**
     * Fired when the user click on the "edit" action button.
     *
     * This event does not bubbles.
     *
     * @event edit-request
     * @param {Object} item The request object
     */
    /**
     * Fired when the user click on the "delete" action button.
     *
     * This event does not bubbles.
     *
     * @event delete-request
     * @param {Object} item The request object
     */
    /**
     * Fired when the user opens the project item.
     *
     * This event can be fired only if the request has a project.
     *
     * @event navigate
     * @param {String} base Always `project`
     * @param {String} id Project ID
     */
    properties: {
      //
      request: Object,
      // True if current item represent a history item.
      isHistory: {
        type: Boolean,
        value: false
      },
      // Request's project data, if any
      _project: Object,
      // Events taget for data model.
      _eventsTarget: {
        type: Object,
        value: function() {
          return this;
        }
      }
    },

    observers: [
      '_requestChanged(request)'
    ],
    /**
     * Sets project data when `request` object change.
     */
    _requestChanged: function(request) {
      if (!request) {
        this._project = undefined;
        return;
      }
      if (request.legacyProject) {
        this._readProject(request.legacyProject);
      } else if (this._project) {
        this._project = undefined;
      }
    },
    // Reads related project data.
    _readProject: function(id) {
      if (this._project && id === this._project._id) {
        return;
      }
      var event = this.fire('project-read', {
        id: id
      }, {
        cancelable: true,
        composed: true
      });
      if (!event.defaultPrevented) {
        throw new Error('Model not found');
      }
      event.detail.result.then(data => {
        this._project = data;
        Polymer.RenderStatus.afterNextRender(this, function() {
          this.notifyResize();
        });
      });
    },
    // Sends `navigate` event set to current read project.
    _openProject: function() {
      this.fire('navigate', {
        base: 'project',
        id: this._project._id
      }, {
        cancelable: true,
        composed: true
      });
    },

    /**
     * Sends non-bubbling `delete-request` event to the parent element to perform
     * delete action.
     */
    _deleteRequest: function() {
      this.fire('delete-request', {
        item: this.request
      }, {
        bubbles: false
      });
    },

    /**
     * Sends non-bubbling `edit-request` event to the parent element to perform
     * edit action.
     */
    _editRequest: function() {
      this.fire('edit-request', {
        item: this.request
      }, {
        bubbles: false
      });
    }
  });
  </script>
</dom-module>
